name: verify
on: [push, pull_request]

jobs:
  lint:
    name: Ansible Lint # Naming the build is important to use it as a status check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install ansible and ansible-lint
        run: pip install ansible ansible-lint
      
      - name: Install Ansible dependencies
        run: |
          cd ansible
          ansible-galaxy install -r requirements.yml
      
      - name: Run ansible-lint
        run: |
          cd ansible
          ansible-lint .

  # https://github.com/geerlingguy/ansible-role-redis/blob/master/.github/workflows/ci.yml
  deploy-test:
    runs-on: ubuntu-24.04
    name: Molecule Test
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Create test project
        run: |
          mkdir -p /tmp/simple_test_project
          cd /tmp/simple_test_project
          
          # Create a simple role structure
          mkdir -p roles/test_role/{defaults,meta,tasks}
          
          # Create minimal meta file
          echo "---" > roles/test_role/meta/main.yml
          echo "galaxy_info:" >> roles/test_role/meta/main.yml
          echo "  author: Test" >> roles/test_role/meta/main.yml
          echo "  description: Test role" >> roles/test_role/meta/main.yml
          echo "  min_ansible_version: 2.10" >> roles/test_role/meta/main.yml
          
          # Create minimal task
          echo "---" > roles/test_role/tasks/main.yml
          echo "- name: Test task" >> roles/test_role/tasks/main.yml
          echo "  debug:" >> roles/test_role/tasks/main.yml
          echo "    msg: Hello world" >> roles/test_role/tasks/main.yml
          
          # Create molecule test
          mkdir -p roles/test_role/molecule/default
          
          cat > roles/test_role/molecule/default/molecule.yml << EOF
          ---
          dependency:
            name: galaxy
            enabled: false
          driver:
            name: docker
          platforms:
            - name: instance
              image: ubuntu:latest
          provisioner:
            name: ansible
          verifier:
            name: ansible
          EOF
          
          cat > roles/test_role/molecule/default/converge.yml << EOF
          ---
          - name: Converge
            hosts: all
            tasks:
              - name: Include test_role
                include_role:
                  name: test_role
          EOF
          
          cat > roles/test_role/molecule/default/verify.yml << EOF
          ---
          - name: Verify
            hosts: all
            gather_facts: false
            tasks:
              - name: Example verification task
                debug:
                  msg: "Verification successful"
          EOF
      
      - name: Run molecule test
        run: |
          cd /tmp/simple_test_project
          pip install ansible molecule molecule-docker
          cd roles/test_role
          molecule test
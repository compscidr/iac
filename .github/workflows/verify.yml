name: verify
on: [push, pull_request]

jobs:
  lint:
    name: Ansible Lint # Naming the build is important to use it as a status check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install ansible and ansible-lint
        run: pip install ansible ansible-lint
      
      - name: Install Ansible dependencies
        run: |
          cd ansible
          ansible-galaxy install -r requirements.yml
      
      - name: Run ansible-lint
        run: |
          cd ansible
          ansible-lint .

  # https://github.com/geerlingguy/ansible-role-redis/blob/master/.github/workflows/ci.yml
  deploy-test:
    runs-on: ubuntu-22.04
    name: Molecule Test
    steps:
      - uses: actions/checkout@v4
        with:
          path: 'iac'
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible molecule molecule-docker pytest pytest-testinfra

      - name: Create ansible.cfg to avoid permission issues
        run: |
          cat > $HOME/ansible.cfg << EOF
          [defaults]
          remote_tmp = /tmp/.ansible
          local_tmp = /tmp/.ansible-local
          EOF
          export ANSIBLE_CONFIG=$HOME/ansible.cfg
          echo "ANSIBLE_CONFIG=$HOME/ansible.cfg" >> $GITHUB_ENV

      - name: Create simple test playbook for common.yml and dev.yml
        working-directory: ./iac/ansible
        run: |
          mkdir -p molecule/default
          
          # Create molecule configuration
          cat > molecule/default/molecule.yml << EOF
          ---
          dependency:
            name: galaxy
          driver:
            name: docker
          platforms:
            - name: instance
              image: ubuntu:22.04
              pre_build_image: true
              command: "/sbin/init"
              capabilities:
                - SYS_ADMIN
              volumes:
                - /sys/fs/cgroup:/sys/fs/cgroup:rw
              tmpfs:
                - /tmp
                - /run
                - /run/lock
              privileged: true
              environment:
                ANSIBLE_USER: ansible
                SUDO_GROUP: sudo
                DEPLOY_GROUP: deployer
                container: docker
          provisioner:
            name: ansible
            env:
              ANSIBLE_FORCE_COLOR: "true"
            config_options:
              defaults:
                remote_tmp: /tmp/.ansible
                interpreter_python: auto_silent
                stdout_callback: yaml
          verifier:
            name: ansible
          EOF
          
          # Create converge playbook that simulates common.yml structure
          cat > molecule/default/converge.yml << EOF
          ---
          # Prepare the instance first
          - name: Prepare the instance
            hosts: all
            gather_facts: false
            tasks:
              - name: Install sudo and python
                raw: apt-get update && apt-get install -y sudo python3
                changed_when: false

              - name: Gather facts
                setup:

          # Test common.yml structure
          - name: Common tasks for all hosts
            hosts: all
            become: true
            tasks:
              - name: Update apt cache
                apt:
                  update_cache: yes
                  cache_valid_time: 3600
                
              - name: Install common packages (from common.yml)
                apt:
                  name: 
                    - git
                    - curl
                    - htop
                  state: present

          # Test dev.yml structure
          - name: Developer tools
            hosts: all
            become: true
            tasks:             
              - name: Install dev packages (from dev.yml)
                apt:
                  name:
                    - build-essential
                    - python3-pip
                  state: present
          EOF
          
          # Create verify.yml
          cat > molecule/default/verify.yml << EOF
          ---
          - name: Verify
            hosts: all
            become: true
            gather_facts: false
            tasks:
              - name: Check if packages are installed
                command: dpkg-query -W {{ item }}
                register: pkg_check
                changed_when: false
                loop:
                  - curl
                  - git
                  - htop
                  - build-essential
                  - python3-pip
                ignore_errors: true
                
              - name: Report package installation status
                debug:
                  msg: "Package {{ item.item }} {{ 'is' if item.rc == 0 else 'is not' }} installed"
                loop: "{{ pkg_check.results }}"
              
              - name: Verify common.yml and dev.yml packages were installed
                assert:
                  that:
                    - pkg_check.results | selectattr('rc', 'eq', 0) | list | length > 3
                  fail_msg: "Required packages from common.yml and dev.yml were not installed"
                  success_msg: "Packages from common.yml and dev.yml were successfully installed"
          EOF
      
      - name: Run molecule test with debug
        working-directory: ./iac/ansible
        env:
          ANSIBLE_VERBOSITY: 1
          PY_COLORS: 1
          ANSIBLE_FORCE_COLOR: 1
          MOLECULE_DEBUG: 1
        run: |
          molecule test
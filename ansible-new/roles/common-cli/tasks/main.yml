---
# https://www.jeffgeerling.com/blog/2022/aptkey-deprecated-debianubuntu-how-fix-ansible
# https://gist.github.com/roib20/27fde10af195cee1c1f8ac5f68be7e9b
- name: Install 1password apt repo
  tags: 1password
  become: true
  ansible.builtin.deb822_repository:
    name: 1password
    types: [deb]
    uris: https://downloads.1password.com/linux/debian/{{ [ansible_architecture] | map('extract', deb_architecture) | first }}/
    signed_by: https://downloads.1password.com/linux/keys/1password.asc
    suites: [stable]
    components: [main]
    state: present
    enabled: yes

- name: Install 1password cli
  tags: 1password
  become: true
  ansible.builtin.apt:
    update_cache: true
    pkg:
      - 1password-cli

- name: Ensure GPG directory exists
  tags: gpg
  become_user: "{{ username }}"
  file:
    path: "~/.gpg"
    mode: "0700"
    state: directory

- name: Copy GPG key
  tags: gpg
  become_user: "{{ username }}"
  ansible.builtin.copy:
    content: "{{ lookup('community.general.onepassword', 'GPG Key', field='notesPlain', vault='Infrastructure') }}"
    dest: "~/.gpg/{{ username }}.gpg"
    mode: "0600"
  notify: 
    - Import GPG private key

- name: Configure git preferences
  become_user: "{{ username }}"
  community.general.git_config:
    scope: global
    name: "{{ item.name }}"
    value: "{{ item.value }}"
  loop:
    - name: user.email
      value: "{{ email }}" 
    - name: user.name
      value: "{{ fullname }}"
    - name: init.defaultBranch
      value: main
    - name: user.signingkey
      value: "{{ signingkey }}"

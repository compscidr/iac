---
# Mail server playbook - deploys Mailu on www droplet (consolidated)
#
# Usage:
#   ansible-playbook -i inventory.yml mail.yml --limit www
#
# After deployment:
#   1. Get DKIM key: ssh www "cat /opt/mailu/dkim/jasonernst.com.dkim.key"
#   2. Update the DKIM DNS record in DigitalOcean
#   3. Access webmail at https://mail.jasonernst.com/webmail
#   4. Access admin at https://mail.jasonernst.com/admin

- name: Deploy Mailu mail server (consolidated on www)
  hosts: www
  gather_facts: true

  pre_tasks:
    - name: Ensure nginx-proxy network exists
      become: true
      community.docker.docker_network:
        name: nginx-proxy
        state: present

    - name: Ensure certs volume exists
      become: true
      community.docker.docker_volume:
        name: certs
        state: present

    # Connect existing containers to nginx-proxy network (idempotent - fails silently if already connected)
    - name: Connect nginx-proxy container to nginx-proxy network
      become: true
      ansible.builtin.command:
        cmd: docker network connect nginx-proxy nginx-proxy
      register: connect_nginx
      changed_when: connect_nginx.rc == 0
      failed_when: false

    - name: Connect letsencrypt container to nginx-proxy network
      become: true
      ansible.builtin.command:
        cmd: docker network connect nginx-proxy letsencrypt
      register: connect_letsencrypt
      changed_when: connect_letsencrypt.rc == 0
      failed_when: false

  roles:
    - mailu

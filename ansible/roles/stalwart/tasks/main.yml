---
# Stalwart Mail Server installation and configuration

- name: Install required packages
  become: true
  ansible.builtin.apt:
    name:
      - curl
      - ca-certificates
      - ufw
    state: present
    update_cache: true

- name: Create stalwart system user
  become: true
  ansible.builtin.user:
    name: stalwart
    system: true
    shell: /usr/sbin/nologin
    home: "{{ stalwart_data_dir }}"
    create_home: false

- name: Create stalwart directories
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: stalwart
    group: stalwart
  loop:
    - "{{ stalwart_data_dir }}"
    - "{{ stalwart_data_dir }}/bin"
    - "{{ stalwart_data_dir }}/etc"
    - "{{ stalwart_data_dir }}/etc/dkim"
    - "{{ stalwart_data_dir }}/etc/certs"
    - "{{ stalwart_data_dir }}/data"
    - "{{ stalwart_data_dir }}/queue"
    - "{{ stalwart_data_dir }}/reports"

- name: Check if Stalwart server is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/stalwart-mail
  register: stalwart_binary

- name: Download and install Stalwart (with checksum verification)
  become: true
  when: not stalwart_binary.stat.exists
  block:
    - name: Download Stalwart server tarball
      ansible.builtin.get_url:
        url: "{{ stalwart_server_url }}"
        dest: /tmp/stalwart-server.tar.gz
        mode: '0644'
        checksum: "{{ stalwart_server_checksum }}"

    - name: Download Stalwart CLI tarball
      ansible.builtin.get_url:
        url: "{{ stalwart_cli_url }}"
        dest: /tmp/stalwart-cli.tar.gz
        mode: '0644'
        checksum: "{{ stalwart_cli_checksum }}"

    - name: Extract Stalwart server
      ansible.builtin.unarchive:
        src: /tmp/stalwart-server.tar.gz
        dest: "{{ stalwart_data_dir }}/bin"
        remote_src: true

    - name: Extract Stalwart CLI
      ansible.builtin.unarchive:
        src: /tmp/stalwart-cli.tar.gz
        dest: "{{ stalwart_data_dir }}/bin"
        remote_src: true

    - name: Create symlink for stalwart-mail
      ansible.builtin.file:
        src: "{{ stalwart_data_dir }}/bin/stalwart-mail"
        dest: /usr/local/bin/stalwart-mail
        state: link

    - name: Create symlink for stalwart-cli
      ansible.builtin.file:
        src: "{{ stalwart_data_dir }}/bin/stalwart-cli"
        dest: /usr/local/bin/stalwart-cli
        state: link

    - name: Clean up downloaded tarballs
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/stalwart-server.tar.gz
        - /tmp/stalwart-cli.tar.gz

    - name: Fix ownership
      ansible.builtin.file:
        path: "{{ stalwart_data_dir }}"
        state: directory
        recurse: true
        owner: stalwart
        group: stalwart

- name: Configure UFW for mail services
  become: true
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "{{ stalwart_smtp_port }}"
    - "{{ stalwart_submission_port }}"
    - "{{ stalwart_submissions_port }}"
    - "{{ stalwart_imap_port }}"
    - "{{ stalwart_imaps_port }}"
    - "{{ stalwart_http_port }}"
    - "80"   # HTTP for ACME challenges
    - "22"   # SSH

# Management port (8080) intentionally NOT opened - use SSH tunnel

- name: Enable UFW
  become: true
  community.general.ufw:
    state: enabled
    policy: deny

- name: Deploy Stalwart configuration
  become: true
  ansible.builtin.template:
    src: config.toml.j2
    dest: "{{ stalwart_data_dir }}/etc/config.toml"
    mode: '0640'
    owner: stalwart
    group: stalwart
  notify: Restart stalwart

- name: Create systemd service file
  become: true
  ansible.builtin.template:
    src: stalwart-mail.service.j2
    dest: /etc/systemd/system/stalwart-mail.service
    mode: '0644'
  notify:
    - Reload systemd
    - Restart stalwart

- name: Enable and start Stalwart service
  become: true
  ansible.builtin.systemd:
    name: stalwart-mail
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for Stalwart to be ready
  ansible.builtin.wait_for:
    port: "{{ stalwart_smtp_port }}"
    timeout: 60

- name: Display post-install instructions
  ansible.builtin.debug:
    msg: |
      Stalwart Mail Server v{{ stalwart_version }} installed successfully!
      
      Binaries verified with SHA256 checksum.
      Admin account pre-configured from 1Password (user: {{ stalwart_admin_user }})
      
      Next steps:
      1. Generate DKIM key:
         sudo openssl genpkey -algorithm ed25519 -out {{ stalwart_data_dir }}/etc/dkim/{{ stalwart_domain }}.key
         sudo chown stalwart:stalwart {{ stalwart_data_dir }}/etc/dkim/{{ stalwart_domain }}.key
         sudo chmod 600 {{ stalwart_data_dir }}/etc/dkim/{{ stalwart_domain }}.key
      
      2. Get public key for DNS:
         sudo openssl pkey -in {{ stalwart_data_dir }}/etc/dkim/{{ stalwart_domain }}.key -pubout 2>/dev/null | openssl asn1parse -offset 12 -noout -out /dev/stdout | base64
      
      3. Update Terraform with the public key in mail.tf (ed25519._domainkey.{{ stalwart_domain }})
         Then run: terraform apply
      
      4. Restart Stalwart to pick up the key:
         sudo systemctl restart stalwart-mail
      
      5. Access admin UI via SSH tunnel:
         ssh -L 8080:localhost:8080 root@{{ stalwart_hostname }}
         Then open http://localhost:8080 (login with 1Password credentials)
      
      6. Create user accounts (e.g., kai@{{ stalwart_domain }}, jason@{{ stalwart_domain }})
      
      Test commands:
      - Check SMTP: telnet {{ stalwart_hostname }} 25
      - Check IMAP: openssl s_client -connect {{ stalwart_hostname }}:993
      - Test DKIM: dig TXT {{ stalwart_dkim_selector }}._domainkey.{{ stalwart_domain }} +short

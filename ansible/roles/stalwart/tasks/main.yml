---
# Stalwart Mail Server installation and configuration

- name: Install required packages
  become: true
  ansible.builtin.apt:
    name:
      - curl
      - ca-certificates
      - ufw
    state: present
    update_cache: true

- name: Create stalwart system user
  become: true
  ansible.builtin.user:
    name: stalwart
    system: true
    shell: /usr/sbin/nologin
    home: "{{ stalwart_data_dir }}"
    create_home: false

- name: Create stalwart directories
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: stalwart
    group: stalwart
  loop:
    - "{{ stalwart_data_dir }}"
    - "{{ stalwart_data_dir }}/etc"
    - "{{ stalwart_data_dir }}/etc/dkim"
    - "{{ stalwart_data_dir }}/etc/certs"
    - "{{ stalwart_data_dir }}/data"
    - "{{ stalwart_data_dir }}/queue"
    - "{{ stalwart_data_dir }}/reports"

- name: Check if Stalwart is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/stalwart-mail
  register: stalwart_binary

- name: Download and install Stalwart
  become: true
  when: not stalwart_binary.stat.exists
  block:
    - name: Download Stalwart install script
      ansible.builtin.get_url:
        url: https://get.stalw.art/install.sh
        dest: /tmp/stalwart-install.sh
        mode: '0755'
      # Note: Checksum verification recommended for production
      # checksum: "sha256:{{ stalwart_install_checksum }}"

    - name: Run Stalwart installer
      ansible.builtin.shell: |
        /tmp/stalwart-install.sh --prefix {{ stalwart_data_dir }} --component all-in-one
      args:
        creates: /usr/local/bin/stalwart-mail

    - name: Fix ownership after install
      ansible.builtin.file:
        path: "{{ stalwart_data_dir }}"
        state: directory
        recurse: true
        owner: stalwart
        group: stalwart

- name: Configure UFW for mail services
  become: true
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "{{ stalwart_smtp_port }}"
    - "{{ stalwart_submission_port }}"
    - "{{ stalwart_submissions_port }}"
    - "{{ stalwart_imap_port }}"
    - "{{ stalwart_imaps_port }}"
    - "{{ stalwart_http_port }}"
    - "80"   # HTTP for ACME challenges
    - "22"   # SSH

# Management port (8080) intentionally NOT opened - use SSH tunnel

- name: Enable UFW
  become: true
  community.general.ufw:
    state: enabled
    policy: deny

- name: Deploy Stalwart configuration
  become: true
  ansible.builtin.template:
    src: config.toml.j2
    dest: "{{ stalwart_data_dir }}/etc/config.toml"
    mode: '0640'
    owner: stalwart
    group: stalwart
  notify: Restart stalwart

- name: Create systemd service file
  become: true
  ansible.builtin.template:
    src: stalwart-mail.service.j2
    dest: /etc/systemd/system/stalwart-mail.service
    mode: '0644'
  notify:
    - Reload systemd
    - Restart stalwart

- name: Enable and start Stalwart service
  become: true
  ansible.builtin.systemd:
    name: stalwart-mail
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for Stalwart to be ready
  ansible.builtin.wait_for:
    port: "{{ stalwart_smtp_port }}"
    timeout: 60

- name: Display post-install instructions
  ansible.builtin.debug:
    msg: |
      Stalwart Mail Server installed successfully!
      
      Next steps:
      1. SSH tunnel to access admin: ssh -L 8080:localhost:8080 root@{{ stalwart_hostname }}
      2. Open http://localhost:8080 in browser
      3. Generate DKIM key via admin UI or CLI:
         stalwart-cli -u http://localhost:8080 domain create {{ stalwart_domain }}
      4. Update the DKIM DNS record in Terraform with the generated public key
      5. Create user accounts (e.g., kai@{{ stalwart_domain }})
      
      Test commands:
      - Check SMTP: telnet {{ stalwart_hostname }} 25
      - Check IMAP: openssl s_client -connect {{ stalwart_hostname }}:993

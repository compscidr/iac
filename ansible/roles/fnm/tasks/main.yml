---
# fnm - Fast Node Manager
# https://github.com/Schniz/fnm

- name: Remove apt nodejs/npm packages (cleanup old installs)
  become: true
  tags:
    - fnm
    - node
    - cleanup
  ansible.builtin.apt:
    pkg:
      - nodejs
      - npm
    state: absent
    autoremove: true
  when:
    - fnm_cleanup_apt | default(true)
    - ansible_os_family == "Debian"

- name: Install fnm dependencies (unzip, curl)
  become: true
  tags:
    - fnm
    - node
  ansible.builtin.apt:
    pkg:
      - unzip
      - curl
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: Check if fnm is installed
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: which fnm || echo "not found"
  register: fnm_check
  changed_when: false
  tags:
    - fnm
    - node

- name: Install fnm via install script (Linux)
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    curl -fsSL https://fnm.vercel.app/install | bash -s -- --skip-shell
  args:
    creates: "{{ ansible_env.HOME }}/.local/share/fnm/fnm"
  when:
    - ansible_system == "Linux"
    - "'not found' in fnm_check.stdout"
  tags:
    - fnm
    - node

- name: Install fnm via Homebrew (macOS)
  community.general.homebrew:
    name: fnm
    state: present
  when:
    - ansible_os_family == "Darwin"
    - "'not found' in fnm_check.stdout"
  tags:
    - fnm
    - node

- name: Add fnm to bashrc (Linux)
  become: true
  become_user: "{{ username }}"
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED - fnm"
    block: |
      # fnm (Fast Node Manager)
      FNM_PATH="{{ ansible_env.HOME }}/.local/share/fnm"
      if [ -d "$FNM_PATH" ]; then
        export PATH="$FNM_PATH:$PATH"
        eval "$(fnm env --use-on-cd --shell bash)"
      fi
    create: true
  when:
    - ansible_system == "Linux"
    - fnm_configure_shell | default(true)
  tags:
    - fnm
    - node

- name: Add fnm to zshrc (Linux)
  become: true
  become_user: "{{ username }}"
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED - fnm"
    block: |
      # fnm (Fast Node Manager)
      FNM_PATH="{{ ansible_env.HOME }}/.local/share/fnm"
      if [ -d "$FNM_PATH" ]; then
        export PATH="$FNM_PATH:$PATH"
        eval "$(fnm env --use-on-cd --shell zsh)"
      fi
    create: true
  when:
    - ansible_system == "Linux"
    - fnm_configure_shell | default(true)
  tags:
    - fnm
    - node

- name: Add fnm to zshrc (macOS)
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED - fnm"
    block: |
      # fnm (Fast Node Manager) - installed via Homebrew
      eval "$(fnm env --use-on-cd --shell zsh)"
    create: true
  when:
    - ansible_os_family == "Darwin"
    - fnm_configure_shell | default(true)
  tags:
    - fnm
    - node

- name: Check installed Node versions
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    export PATH="{{ ansible_env.HOME }}/.local/share/fnm:/opt/homebrew/bin:$PATH"
    fnm list 2>/dev/null | grep -q "{{ fnm_node_version }}" && echo "installed" || echo "not installed"
  register: node_version_check
  changed_when: false
  tags:
    - fnm
    - node

- name: Install Node.js version via fnm
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    export PATH="{{ ansible_env.HOME }}/.local/share/fnm:/opt/homebrew/bin:$PATH"
    eval "$(fnm env)"
    fnm install {{ fnm_node_version }}
  when: "'not installed' in node_version_check.stdout"
  tags:
    - fnm
    - node

- name: Set default Node.js version
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    export PATH="{{ ansible_env.HOME }}/.local/share/fnm:/opt/homebrew/bin:$PATH"
    eval "$(fnm env)"
    fnm default {{ fnm_node_version }}
  when: fnm_set_default | default(true)
  changed_when: false
  tags:
    - fnm
    - node

---
# Mailu mail server deployment (consolidated on www with nginx-proxy)

# Ensure nginx-proxy infrastructure is ready
- name: Create nginx-proxy network
  become: true
  community.docker.docker_network:
    name: nginx-proxy
    state: present

- name: Connect nginx-proxy container to nginx-proxy network
  become: true
  ansible.builtin.command:
    cmd: docker network connect nginx-proxy nginx-proxy
  register: connect_nginx
  changed_when: connect_nginx.rc == 0
  failed_when: false

- name: Connect letsencrypt container to nginx-proxy network
  become: true
  ansible.builtin.command:
    cmd: docker network connect nginx-proxy letsencrypt
  register: connect_letsencrypt
  changed_when: connect_letsencrypt.rc == 0
  failed_when: false

- name: Connect www.jasonernst.com container to nginx-proxy network
  become: true
  ansible.builtin.command:
    cmd: docker network connect nginx-proxy www.jasonernst.com
  register: connect_www
  changed_when: connect_www.rc == 0
  failed_when: false

- name: Connect staging.jasonernst.com container to nginx-proxy network
  become: true
  ansible.builtin.command:
    cmd: docker network connect nginx-proxy staging.jasonernst.com
  register: connect_staging
  changed_when: connect_staging.rc == 0
  failed_when: false

- name: Ensure certs volume exists
  become: true
  community.docker.docker_volume:
    name: certs
    state: present

- name: Create Mailu directory
  become: true
  ansible.builtin.file:
    path: "{{ mailu_install_path }}"
    state: directory
    mode: '755'

- name: Create Mailu data directories
  become: true
  ansible.builtin.file:
    path: "{{ mailu_install_path }}/{{ item }}"
    state: directory
    mode: '755'
  loop:
    - data
    - dkim
    - mail
    - overrides
    - overrides/nginx
    - overrides/dovecot
    - overrides/postfix
    - overrides/rspamd
    - overrides/roundcube
    - redis
    - webmail
    - filter
    - mailqueue

- name: Deploy mailu.env
  become: true
  ansible.builtin.template:
    src: mailu.env.j2
    dest: "{{ mailu_install_path }}/mailu.env"
    mode: '600'
  notify: Restart Mailu

- name: Deploy docker-compose.yml
  become: true
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ mailu_install_path }}/docker-compose.yml"
    mode: '644'
  notify: Restart Mailu

- name: Start Mailu stack
  become: true
  community.docker.docker_compose_v2:
    project_src: "{{ mailu_install_path }}"
    state: present
    pull: always

- name: Wait for Mailu to be ready
  become: true
  ansible.builtin.wait_for:
    port: 443  # nginx-proxy handles HTTPS
    delay: 10
    timeout: 120

- name: Create admin user
  become: true
  ansible.builtin.command:
    cmd: >
      docker compose exec -T admin flask mailu admin
      {{ mailu_admin_user }} {{ mailu_domain }} {{ mailu_admin_password }}
  args:
    chdir: "{{ mailu_install_path }}"
  register: admin_result
  changed_when: "'created' in admin_result.stdout"
  failed_when: false  # May fail if user exists
  no_log: true  # Hide admin password

- name: Create mail users
  become: true
  ansible.builtin.command:
    cmd: >
      docker compose exec -T admin flask mailu user
      {{ item.user }} {{ mailu_domain }} {{ item.password }}
  args:
    chdir: "{{ mailu_install_path }}"
  loop: "{{ mailu_users }}"
  register: user_result
  changed_when: false  # Can't reliably detect from looped command
  failed_when: false  # May fail if user exists
  no_log: true  # Hide passwords

- name: Get DKIM public key
  become: true
  ansible.builtin.command:
    cmd: cat "{{ mailu_install_path }}/dkim/{{ mailu_domain }}.dkim.key"
  register: dkim_key
  changed_when: false
  failed_when: false

- name: Display DKIM key for DNS
  ansible.builtin.debug:
    msg: |
      Add this DKIM record to DNS:
      Name: dkim._domainkey.{{ mailu_domain }}
      Type: TXT
      Value: {{ dkim_key.stdout | default('DKIM key not yet generated - restart admin container') }}
  when: dkim_key.stdout is defined and dkim_key.stdout | length > 0

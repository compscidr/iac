---
# Ensure variables are set before including roles
# (Role defaults don't pass through to included collection roles)
- name: Set media defaults
  tags: always
  ansible.builtin.set_fact:
    media_user_user: jason
    media_user_group: admin
    media_storage_base_path: /volume1/storage
    media_storage_network_enabled: true
    media_storage_network_name: "media"

# Initialize media_user facts (UID/GID detection) before other tasks
# This runs media_storage which depends on media_user
- name: Initialize media storage and user facts
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.media_storage
    apply:
      become: true

# Nginx reverse proxy + LetsEncrypt for SSL certs
- name: Create nginx config directory
  tags: nginx
  become: true
  ansible.builtin.file:
    path: /etc/nginx-proxy/conf.d
    state: directory
    mode: '755'
    owner: root
    group: root

- name: Copy nginx config
  tags: nginx
  become: true
  ansible.builtin.copy:
    content: "client_max_body_size 100m;"
    dest: /etc/nginx-proxy/conf.d/client_max_body_size.conf
    mode: '644'
    owner: root
    group: root

- name: Deploy Nginx Reverse Proxy
  tags: nginx
  become: true
  community.docker.docker_container:
    name: nginx-proxy
    image: jwilder/nginx-proxy
    published_ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/nginx-proxy/conf.d:/etc/nginx/conf.d
      - nginx-vhost:/etc/nginx/vhost.d
      - nginx-html:/usr/share/nginx/html
      - nginx-dhparam:/etc/nginx/dhparam
      - nginx-certs:/etc/nginx/certs:ro
      - /var/run/docker.sock:/tmp/docker.sock:ro
    networks:
      - name: media
    restart_policy: unless-stopped

- name: Deploy LetsEncrypt companion
  tags: letsencrypt
  become: true
  community.docker.docker_container:
    name: letsencrypt
    image: jrcs/letsencrypt-nginx-proxy-companion
    volumes:
      - nginx-certs:/etc/nginx/certs:rw
      - nginx-vhost:/etc/nginx/vhost.d
      - nginx-html:/usr/share/nginx/html
      - /var/run/docker.sock:/var/run/docker.sock:ro
    env:
      NGINX_PROXY_CONTAINER: "nginx-proxy"
    networks:
      - name: media
    restart_policy: unless-stopped

# Media storage folders are now created automatically by the media_storage role
# which is a dependency of the media roles below

- name: Create Transmission Directories
  tags: transmission
  become: true
  ansible.builtin.file:
    path: "/etc/transmission/"
    state: directory
    mode: '755'
    owner: "{{ media_user_user }}"
    group: "{{ media_user_group }}"

- name: Set transmission nordvpn credentials
  tags: transmission
  become: true
  ansible.builtin.copy:
    mode: '755'
    owner: "{{ media_user_user }}"
    group: "{{ media_user_group }}"
    dest: "/etc/transmission/.env"
    content: |
      TRANSMISSION_WEB_UI=transmission-web-control
      OPENVPN_PROVIDER=NORDVPN
      NORDVPN_PROTOCOL=udp
      OPENVPN_USERNAME={{ lookup('community.general.onepassword', 'NordVPN Manual', field='username', vault=onepassword_vault, account_id=onepassword_account_id) }}
      OPENVPN_PASSWORD={{ lookup('community.general.onepassword', 'NordVPN Manual', field='credential', vault=onepassword_vault, account_id=onepassword_account_id) }}
      NORDVPN_COUNTRY=US
      NORDVPN_CATEGORY=P2P
      LOCAL_NETWORK=192.168.0.0/24
      HEALTH_CHECK_HOST=8.8.8.8

- name: Install transmission
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.transmission
    apply:
      become: true
      tags: transmission
  vars:
    transmission_folder: /etc/transmission
    transmission_memory: "5g"
    transmission_memory_swap: "5g"

- name: Install plex
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.plex
    apply:
      become: true
      tags: plex
  vars:
    plex_dri_devices: true
    plex_bonjour_port: 5354
    plex_claim: claim-haziyvUxG2Fb4uj5-tF1
    plex_memory: "5g"
    plex_memory_swap: "5g"
    # Use host mode for DLNA/UPnP discovery
    plex_network_mode: "host"

- name: Install sabnzbd
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.sabnzbd
    apply:
      become: true
      tags: sabnzbd
  vars:
    sabnzbd_memory: "5g"
    sabnzbd_memory_swap: "5g"

- name: Install sonarr
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.sonarr
    apply:
      become: true
      tags: sonarr
  vars:
    sonarr_folder: /etc/sonarr
    sonarr_memory: "1g"
    sonarr_memory_swap: "1g"

- name: Install radarr
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.radarr
    apply:
      become: true
      tags: radarr
  vars:
    radarr_memory: "1g"
    radarr_memory_swap: "1g"

- name: Install prowlarr
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.prowlarr
    apply:
      become: true
      tags: prowlarr
  vars:
    prowlarr_memory: "1g"
    prowlarr_memory_swap: "1g"

- name: Install flaresolverr
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.flaresolverr
    apply:
      become: true
      tags: flaresolverr
  vars:
    flare_port: 8191

- name: Install ombi
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.ombi
    apply:
      become: true
      tags: ombi
  vars:
    ombi_virtual_host: "ombi.jasonernst.com"
    ombi_letsencrypt_email: "ernstjason1@gmail.com"

- name: Install slskd
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.slskd
    apply:
      become: true
      tags: slskd
  vars:
    slskd_memory: "1g"
    slskd_memory_swap: "1g"

- name: Install soularr
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.soularr
    apply:
      become: true
      tags: soularr
  vars:
    soularr_memory: "1g"
    soularr_memory_swap: "1g"

- name: Install lidarr
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.lidarr
    apply:
      become: true
      tags: lidarr
  vars:
    lidarr_plugins: true
    lidarr_memory: "1g"
    lidarr_memory_swap: "1g"

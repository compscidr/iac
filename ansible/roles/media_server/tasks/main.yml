---
# Initialize media_user facts (UID/GID detection) before other tasks
# This runs media_storage which depends on media_user
- name: Initialize media storage and user facts
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.media_storage
    apply:
      become: true

# Nginx reverse proxy + LetsEncrypt for SSL certs
- name: Create nginx config directory
  tags: nginx
  become: true
  ansible.builtin.file:
    path: /etc/nginx/conf.d
    state: directory
    mode: '755'
    owner: root
    group: root

- name: Copy nginx config
  tags: nginx
  become: true
  ansible.builtin.copy:
    content: "client_max_body_size 100m;"
    dest: /etc/nginx/conf.d/client_max_body_size.conf
    mode: '644'
    owner: root
    group: root

- name: Deploy Nginx Reverse Proxy
  tags: nginx
  become: true
  community.docker.docker_container:
    name: nginx-proxy
    image: jwilder/nginx-proxy
    published_ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/nginx/conf.d:/etc/nginx/conf.d
      - nginx-vhost:/etc/nginx/vhost.d
      - nginx-html:/usr/share/nginx/html
      - nginx-dhparam:/etc/nginx/dhparam
      - nginx-certs:/etc/nginx/certs:ro
      - /var/run/docker.sock:/tmp/docker.sock:ro
    network_mode: bridge
    restart_policy: unless-stopped

- name: Deploy LetsEncrypt companion
  tags: letsencrypt
  become: true
  community.docker.docker_container:
    name: letsencrypt
    image: jrcs/letsencrypt-nginx-proxy-companion
    volumes:
      - nginx-certs:/etc/nginx/certs:rw
      - nginx-vhost:/etc/nginx/vhost.d
      - nginx-html:/usr/share/nginx/html
      - /var/run/docker.sock:/var/run/docker.sock:ro
    env:
      NGINX_PROXY_CONTAINER: "nginx-proxy"
    network_mode: bridge
    restart_policy: unless-stopped

# Media storage folders are now created automatically by the media_storage role
# which is a dependency of the media roles below

- name: Create Transmission Directories
  tags: transmission
  become: true
  ansible.builtin.file:
    path: "/etc/transmission/"
    state: directory
    mode: '755'
    owner: "{{ media_user_user }}"
    group: "{{ media_user_group }}"

- name: Set transmission nordvpn credentials
  tags: transmission
  become: true
  ansible.builtin.copy:
    mode: '755'
    owner: "{{ media_user_user }}"
    group: "{{ media_user_group }}"
    dest: "/etc/transmission/.env"
    content: |
      TRANSMISSION_WEB_UI=transmission-web-control
      OPENVPN_PROVIDER=NORDVPN
      NORDVPN_PROTOCOL=udp
      OPENVPN_USERNAME={{ lookup('community.general.onepassword', 'NordVPN Manual', field='username', vault=onepassword_vault, account_id=onepassword_account_id) }}
      OPENVPN_PASSWORD={{ lookup('community.general.onepassword', 'NordVPN Manual', field='credential', vault=onepassword_vault, account_id=onepassword_account_id) }}
      NORDVPN_COUNTRY=US
      NORDVPN_CATEGORY=P2P
      LOCAL_NETWORK=192.168.0.0/24
      HEALTH_CHECK_HOST=8.8.8.8

- name: Install transmission
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.transmission
    apply:
      become: true
      tags: transmission
  vars:
    transmission_folder: /etc/transmission
    transmission_memory: "5g"
    transmission_memory_swap: "5g"

- name: Install plex
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.plex
    apply:
      become: true
      tags: plex
  vars:
    plex_dri_devices: true
    plex_bonjour_port: 5354
    plex_claim: claim-haziyvUxG2Fb4uj5-tF1
    plex_memory: "5g"
    plex_memory_swap: "5g"
    # Use host mode for DLNA/UPnP discovery
    plex_network_mode: "host"

- name: Install sabnzbd
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.sabnzbd
    apply:
      become: true
      tags: sabnzbd
  vars:
    sabnzbd_memory: "5g"
    sabnzbd_memory_swap: "5g"

- name: Install sonarr
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.sonarr
    apply:
      become: true
      tags: sonarr
  vars:
    sonarr_folder: /etc/sonarr
    sonarr_memory: "1g"
    sonarr_memory_swap: "1g"

- name: Install radarr
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.radarr
    apply:
      become: true
      tags: radarr
  vars:
    radarr_memory: "1g"
    radarr_memory_swap: "1g"

- name: Install prowlarr
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.prowlarr
    apply:
      become: true
      tags: prowlarr
  vars:
    prowlarr_memory: "1g"
    prowlarr_memory_swap: "1g"

- name: Install flaresolverr
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.flaresolverr
    apply:
      become: true
      tags: flaresolverr
  vars:
    flare_port: 8191

- name: Install ombi
  tags: always
  ansible.builtin.include_role:
    name: compscidr.media_server.ombi
    apply:
      become: true
      tags: ombi
  vars:
    ombi_virtual_host: "ombi.jasonernst.com"
    ombi_letsencrypt_email: "ernstjason1@gmail.com"

- name: Deploy MySQL
  tags: mysql
  become: true
  community.docker.docker_container:
    name: mysql
    image: mysql:9
    env:
      MYSQL_ROOT_PASSWORD: "{{ lookup('community.general.onepassword', 'mysql_root', field='password', vault=onepassword_vault, account_id=onepassword_account_id) }}"
    volumes:
      - /volume1/storage/docker/mysql:/var/lib/mysql
    network_mode: bridge
    published_ports:
      - "3306:3306"
    restart_policy: unless-stopped
    memory: "1g"
    memory_swap: "1g"

- name: Create slskd config folder
  tags: slskd
  become: true
  ansible.builtin.file:
    path: /etc/slskd
    state: directory
    owner: "{{ media_user_uid }}"
    group: "{{ media_user_gid }}"
    mode: '0755'

- name: Install slskd
  tags: slskd
  become: true
  community.docker.docker_container:
    name: slskd
    image: slskd/slskd:latest
    pull: true
    volumes:
      - "{{ media_storage_base_path }}/music:/music:rw"
      - "{{ media_storage_base_path }}/downloads/complete/music:/downloads:rw"
      - "{{ media_storage_base_path }}/downloads/incomplete:/incomplete:rw"
      - /etc/slskd:/app
    env:
      PUID: "{{ media_user_uid }}"
      PGID: "{{ media_user_gid }}"
    user: "{{ media_user_uid }}:{{ media_user_gid }}"
    ports:
      - "5030:5030"
      - "5031:5031"
      - "50300:50300"
    restart_policy: unless-stopped
    memory: 1g

- name: Create soularr config folder
  tags: soularr
  become: true
  ansible.builtin.file:
    path: /etc/soularr
    state: directory
    owner: "{{ media_user_uid }}"
    group: "{{ media_user_gid }}"
    mode: '0755'

- name: Install soularr
  tags: soularr
  become: true
  community.docker.docker_container:
    name: soularr
    image: mrusse08/soularr:latest
    user: "{{ media_user_uid }}:{{ media_user_gid }}"
    pull: true
    volumes:
      - "{{ media_storage_base_path }}/downloads/complete/music:/downloads:rw"
      - /etc/soularr:/data
    restart_policy: unless-stopped
    memory: 1g

- name: Create lidarr config folder
  tags: lidarr
  become: true
  ansible.builtin.file:
    path: /etc/lidarr
    state: directory
    owner: "{{ media_user_uid }}"
    group: "{{ media_user_gid }}"
    mode: '0755'

- name: Deploy lidarr
  tags: lidarr
  become: true
  community.docker.docker_container:
    name: lidarr
    image: ghcr.io/hotio/lidarr:pr-plugins
    pull: true
    ports:
      - "8686:8686"
    volumes:
      - "{{ media_storage_base_path }}/music:/music:rw"
      - "{{ media_storage_base_path }}/downloads:/downloads:rw"
      - "/etc/lidarr:/config:rw"
    env:
      TZ: "America/Los_Angeles"
      PUID: "{{ media_user_uid }}"
      PGID: "{{ media_user_gid }}"
    restart_policy: unless-stopped
    memory: "1g"
    memory_swap: "1g"

---
- name: Install prereqs (Ubuntu/Debian)
  become: true
  tags: prereqs
  ansible.builtin.apt:
    update_cache: true
    pkg: "{{ common_cli_prereq_packages_ubuntu }}"
  when: ansible_os_family == "Debian"

- name: Check if Homebrew is installed (macOS)
  ansible.builtin.stat:
    path: /opt/homebrew/bin/brew
  register: homebrew_check
  when: ansible_os_family == "Darwin"

- name: Install Homebrew (macOS)
  ansible.builtin.shell: |
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  args:
    creates: /opt/homebrew/bin/brew
    executable: /bin/bash
  when:
    - ansible_os_family == "Darwin"
    - not homebrew_check.stat.exists

- name: Install prereqs (macOS)
  tags: prereqs
  community.general.homebrew:
    name: "{{ common_cli_prereq_packages_macos }}"
    state: present
  when: ansible_os_family == "Darwin"

- name: Install 1password CLI
  ansible.builtin.include_role:
    name: compscidr.onepassword.onepassword_cli
    apply:
      tags: 1password
      become: true
  tags: always

# Tailscale for workstations (servers get Tailscale via cloud-init)
# Note: This is intentionally idempotent - the 'creates' argument prevents
# re-installation on servers where Tailscale is already installed via cloud-init.
# This allows the same role to handle both server and workstation scenarios.
- name: Install Tailscale
  become: true
  tags: [tailscale]
  ansible.builtin.shell: |
    curl -fsSL https://tailscale.com/install.sh | sh
  args:
    creates: /usr/bin/tailscale

- name: Connect to Tailscale
  become: true
  tags: [tailscale]
  ansible.builtin.command:
    cmd: "tailscale up --authkey={{ tailscale_authkey }}"
  vars:
    tailscale_authkey: "{{ lookup('community.general.onepassword', 'Tailscale', field='credential', vault=onepassword_vault, account_id=onepassword_account_id) }}"
  register: tailscale_up
  changed_when: "'Success' in tailscale_up.stdout or tailscale_up.rc == 0"
  failed_when: false

- name: Add the user
  tags: user
  become: true
  ansible.builtin.user:
    name: "{{ username }}"
    password: "{{ lookup('community.general.onepassword', 'System Account', field='password', vault=onepassword_vault, account_id=onepassword_account_id) | password_hash('sha512') }}"
    comment: "{{ fullname }}"
    shell: "{{ '/bin/zsh' if ansible_os_family == 'Darwin' else '/bin/bash' }}"
    append: true
    groups: "{{ 'admin' if ansible_os_family == 'Darwin' else 'sudo' }}"
    skeleton: "/etc/skel"
    create_home: true
    update_password: on_create

- name: Ensure SSH directory exits
  tags: ssh
  become: true
  become_user: "{{ username }}"
  ansible.builtin.file:
    path: "~/.ssh"
    mode: "0700"
    state: directory

- name: Obtain ssh key
  tags: ssh
  become: true
  become_user: "{{ username }}"
  ansible.builtin.copy:
    content: "{{ lookup('community.general.onepassword', 'Github SSH', field='notesPlain', vault=onepassword_vault, account_id=onepassword_account_id) }}\n"
    dest: "~/.ssh/id_rsa"
    mode: "0600"

- name: Ensure GPG directory exists
  tags: gpg
  become: true
  become_user: "{{ username }}"
  ansible.builtin.file:
    path: "~/.gpg"
    mode: "0700"
    state: directory

- name: Copy GPG key
  tags: gpg
  become: true
  become_user: "{{ username }}"
  ansible.builtin.copy:
    content: "{{ lookup('community.general.onepassword', 'GPG Key', field='notesPlain', vault=onepassword_vault, account_id=onepassword_account_id) }}"
    dest: "~/.gpg/{{ username }}.gpg"
    mode: "0600"

- name: Check if GPG private key is already imported (Linux)
  tags: gpg
  become: true
  become_user: "{{ username }}"
  ansible.builtin.command:
    argv:
      - gpg
      - --batch
      - --list-secret-keys
      - "{{ signingkey }}"
  environment:
    GPG_TTY: ""
  register: gpg_key_check_linux
  failed_when: false
  changed_when: false
  when: ansible_os_family != "Darwin"

- name: Check if GPG private key is already imported (macOS)
  tags: gpg
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    /opt/homebrew/bin/gpg --batch --list-secret-keys "{{ signingkey }}" 2>&1
  register: gpg_key_check_macos
  failed_when: false
  changed_when: false
  when: ansible_os_family == "Darwin"

- name: Import GPG private key (Linux)
  tags: gpg
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    gpg --batch --yes --import ~/.gpg/{{ username }}.gpg
  environment:
    GPG_TTY: ""
  register: gpg_import
  changed_when: "'imported' in (gpg_import.stdout + gpg_import.stderr)"
  when:
    - ansible_os_family != "Darwin"
    - gpg_key_check_linux.rc != 0

- name: Import GPG private key (macOS)
  tags: gpg
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    /opt/homebrew/bin/gpg --batch --yes --no-tty --import ~/.gpg/{{ username }}.gpg 2>&1
  register: gpg_import_macos
  changed_when: "'imported' in (gpg_import_macos.stdout + gpg_import_macos.stderr)"
  when:
    - ansible_os_family == "Darwin"
    - gpg_key_check_macos.rc != 0

- name: Configure git preferences
  become: true
  become_user: "{{ username }}"
  tags: git
  community.general.git_config:
    scope: global
    name: "{{ item.name }}"
    value: "{{ item.value }}"
  loop:
    - name: user.email
      value: "{{ email }}"
    - name: user.name
      value: "{{ fullname }}"
    - name: init.defaultBranch
      value: main
    - name: user.signingkey
      value: "{{ signingkey }}"
    - name: push.autoSetupRemote
      value: true

- name: Create docker group
  become: true
  tags: docker
  ansible.builtin.group:
    name: docker
    state: present
  when: ansible_os_family != "Darwin"

- name: Add user to docker group
  become: true
  tags: docker
  ansible.builtin.user:
    name: "{{ username }}"
    groups: docker
    append: true
  notify: Reset ssh connection
  when: ansible_os_family != "Darwin"

- name: Install various cli tools (Ubuntu/Debian)
  become: true
  tags: cli-tools
  ansible.builtin.apt:
    pkg: "{{ common_cli_tools_ubuntu }}"
  when: ansible_os_family == "Debian"

- name: Install various cli tools (macOS)
  tags: cli-tools
  community.general.homebrew:
    name: "{{ common_cli_tools_macos }}"
    state: present
  when: ansible_os_family == "Darwin"

- name: Remove obsolete isc-dhcp-client (Ubuntu/Debian)
  become: true
  tags: network-tools
  ansible.builtin.apt:
    name: isc-dhcp-client
    state: absent
    purge: true
  when: ansible_os_family == "Debian"

- name: Install network tools (Ubuntu/Debian)
  become: true
  tags: network-tools
  ansible.builtin.apt:
    pkg: "{{ common_cli_network_tools_ubuntu }}"
  when: ansible_os_family == "Debian"

- name: Install network tools (macOS)
  tags: network-tools
  community.general.homebrew:
    name: "{{ common_cli_network_tools_macos }}"
    state: present
  when: ansible_os_family == "Darwin"

- name: Check if NetworkManager is installed and active (Ubuntu/Debian)
  become: true
  tags: network-tools
  ansible.builtin.command: systemctl is-active NetworkManager
  register: networkmanager_check
  failed_when: false
  changed_when: false
  when: ansible_os_family == "Debian"

- name: Set fact for using systemd-networkd (Ubuntu/Debian)
  tags: network-tools
  ansible.builtin.set_fact:
    use_systemd_networkd: "{{ networkmanager_check.rc != 0 }}"
  when: ansible_os_family == "Debian"

- name: Check if cloud-init is installed (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.stat:
    path: /etc/cloud/cloud.cfg.d
  register: cloud_init_dir
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Disable cloud-init network management (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.copy:
    content: "network: {config: disabled}\n"
    dest: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
    mode: "0644"
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - cloud_init_dir.stat.exists

- name: Find cloud-init cached network configs (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.find:
    paths: /var/lib/cloud/instances
    patterns: network-config.json
    file_type: file
    recurse: true
  register: cloud_init_network_configs
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - cloud_init_dir.stat.exists

- name: Remove cloud-init cached network config (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ cloud_init_network_configs.files | default([]) }}"
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - cloud_init_dir.stat.exists
    - cloud_init_network_configs is defined

- name: Remove old netplan configs to prevent interface name conflicts (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.file:
    path: "/etc/netplan/{{ item }}"
    state: absent
  loop:
    - 00-installer-config-wifi.yaml
    - 50-cloud-init.yaml
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Check if netplan generator exists (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.stat:
    path: /usr/lib/systemd/system-generators/netplan
  register: netplan_generator
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Disable netplan generator to prevent phantom interface waits (Ubuntu/Debian headless)
  become: true
  tags:
    - network-tools
    - molecule-idempotence-notest
  ansible.builtin.command:
    cmd: mv /usr/lib/systemd/system-generators/netplan /usr/lib/systemd/system-generators/netplan.disabled
    creates: /usr/lib/systemd/system-generators/netplan.disabled
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - netplan_generator.stat.exists

- name: Check if wpa_supplicant is installed (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.stat:
    path: /lib/systemd/system/wpa_supplicant@.service
  register: wpa_supplicant_service
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Mask wpa_supplicant for wlan0 temporary interface name (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.systemd:
    name: wpa_supplicant@wlan0.service
    masked: true
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - wpa_supplicant_service.stat.exists

- name: Check if systemd is running (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.command: systemctl is-system-running
  register: systemd_running
  failed_when: false
  changed_when: false
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Ensure systemd-networkd is enabled and started (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.systemd:
    name: systemd-networkd
    enabled: true
    state: started
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - systemd_running.rc == 0 or systemd_running.stdout in ['running', 'degraded']

- name: Disable systemd-networkd-wait-online to avoid boot delays (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.systemd:
    name: systemd-networkd-wait-online
    enabled: false
    masked: true
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Deploy systemd-networkd configuration for wired interfaces (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.copy:
    src: systemd-networkd/20-wired.network
    dest: /etc/systemd/network/20-wired.network
    mode: "0644"
    owner: root
    group: root
  notify: Restart systemd-networkd
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Deploy systemd-networkd configuration for wireless interfaces (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.copy:
    src: systemd-networkd/25-wireless.network
    dest: /etc/systemd/network/25-wireless.network
    mode: "0644"
    owner: root
    group: root
  notify: Restart systemd-networkd
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Find old interface-specific networkd configs (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.find:
    paths: /etc/systemd/network
    patterns: "10-*.network"
    file_type: file
  register: old_networkd_configs
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Remove old interface-specific networkd configs (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_networkd_configs.files | default([]) }}"
  notify: Restart systemd-networkd
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - old_networkd_configs is defined

- name: Ensure /etc/wpa_supplicant directory exists (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.file:
    path: /etc/wpa_supplicant
    state: directory
    mode: "0755"
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Get list of wireless interfaces (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.shell: |
    for iface in /sys/class/net/*; do
      if [ -d "$iface/wireless" ]; then
        basename "$iface"
      fi
    done
  register: wireless_interfaces
  changed_when: false
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Get WiFi credentials from 1Password (Ubuntu/Debian headless)
  tags: network-tools
  ansible.builtin.set_fact:
    wifi_ssid: "{{ lookup('community.general.onepassword', 'Wi-Fi', field='username', vault=onepassword_vault, account_id=onepassword_account_id) }}"
    wifi_passphrase: "{{ lookup('community.general.onepassword', 'Wi-Fi', field='password', vault=onepassword_vault, account_id=onepassword_account_id) }}"
  no_log: true
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - wireless_interfaces.stdout_lines | default([]) | length > 0

- name: Generate WPA PSK hash from passphrase (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.shell: |
    wpa_passphrase "{{ wifi_ssid }}" "{{ wifi_passphrase }}" | grep -E '^\s*psk=' | grep -v '#psk' | cut -d= -f2
  register: wifi_psk_hash
  changed_when: false
  no_log: true
  failed_when: wifi_psk_hash.stdout is not defined or (wifi_psk_hash.stdout | trim) == ''
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - wireless_interfaces.stdout_lines | default([]) | length > 0

- name: Deploy wpa_supplicant configuration for each wireless interface (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  # Note: This task deploys config files regardless of systemd running state.
  # Files are needed for initial setup before first boot, and systemd service
  # startup (checked later) handles when services actually start.
  ansible.builtin.template:
    src: wpa_supplicant.conf.j2
    dest: "/etc/wpa_supplicant/wpa_supplicant-{{ item }}.conf"
    mode: "0600"
    owner: root
    group: root
  vars:
    wifi_psk: "{{ wifi_psk_hash.stdout }}"
  loop: "{{ wireless_interfaces.stdout_lines | default([]) }}"
  no_log: true
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - wireless_interfaces.stdout_lines | default([]) | length > 0

- name: Check if udev rules directory exists (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.stat:
    path: /etc/udev/rules.d
  register: udev_rules_dir
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Deploy udev rule for automatic wpa_supplicant on wireless interfaces (Ubuntu/Debian headless)
  become: true
  tags:
    - network-tools
    - molecule-idempotence-notest
  ansible.builtin.copy:
    src: udev/80-wireless-wpa.rules
    dest: /etc/udev/rules.d/80-wireless-wpa.rules
    mode: "0644"
    owner: root
    group: root
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - udev_rules_dir.stat.exists

- name: Reload udev rules (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.command: udevadm control --reload-rules
  changed_when: false
  failed_when: false
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - udev_rules_dir.stat.exists

- name: Create wpa_supplicant override directory (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.file:
    path: /etc/systemd/system/wpa_supplicant@.service.d
    state: directory
    mode: "0755"
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Deploy wpa_supplicant service override to not block boot (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.copy:
    src: systemd/wpa_supplicant@.service.d/override.conf
    dest: /etc/systemd/system/wpa_supplicant@.service.d/override.conf
    mode: "0644"
    owner: root
    group: root
  notify: Reload systemd
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)

- name: Enable and start wpa_supplicant for each wireless interface (Ubuntu/Debian headless)
  become: true
  tags: network-tools
  ansible.builtin.systemd:
    name: "wpa_supplicant@{{ item }}"
    enabled: true
    state: started
  loop: "{{ wireless_interfaces.stdout_lines | default([]) }}"
  when:
    - ansible_os_family == "Debian"
    - use_systemd_networkd | default(false)
    - wireless_interfaces.stdout_lines | default([]) | length > 0
    - systemd_running.rc == 0 or systemd_running.stdout in ['running', 'degraded']

- name: Check if colima is running (macOS)
  tags: docker
  become: true
  become_user: "{{ username }}"
  ansible.builtin.command: /opt/homebrew/bin/colima status
  register: colima_status
  failed_when: false
  changed_when: false
  when: ansible_os_family == "Darwin"

- name: Start colima (macOS)
  tags: docker
  become: true
  become_user: "{{ username }}"
  ansible.builtin.command: /opt/homebrew/bin/colima start --cpu 2 --memory 4
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
  when:
    - ansible_os_family == "Darwin"
    - colima_status.rc != 0

# GitHub known_hosts is handled by bootstrap role

# https://github.com/Strum355/ansible-dotfiles/blob/master/roles/dotfiles/tasks/main.yaml
# without version pinning we get lint errors
- name: Clone dotfile repo
  become: true
  become_user: "{{ username }}"
  tags: dotfiles
  ansible.builtin.git:
    repo: git@github.com:compscidr/dotfiles.git
    dest: ~/dotfiles
    # Pinned commit adds service account token switching + npm-global PATH
    version: b93601386e1ee952d46a6cb8d55124e31c48ca0a

- name: Test .bashrc file to see if its a symlink
  tags: dotfile
  become: true
  become_user: "{{ username }}"
  ansible.builtin.stat:
    path: ~/.bashrc
  register: bash_test

- name: Remove .bashrc file so stow has no conflicts
  tags: dotfiles
  become: true
  become_user: "{{ username }}"
  ansible.builtin.file:
    dest: ~/.bashrc
    state: absent
  when: bash_test.stat.exists and not bash_test.stat.islnk


- name: Deploy dotfiles (Ubuntu/Debian)
  become: true
  become_user: "{{ username }}"
  tags: dotfiles
  with_items: "{{ common_cli_dotfile_packages_ubuntu }}"
  ansible.builtin.command: "stow {{ item }}"
  register: dotfiles_result
  changed_when: "'changed' in dotfiles_result.stdout"
  args:
    chdir: ~/dotfiles
  when: ansible_os_family == "Debian"

- name: Deploy dotfiles (macOS)
  become: true
  become_user: "{{ username }}"
  tags: dotfiles
  with_items: "{{ common_cli_dotfile_packages_macos }}"
  ansible.builtin.command: "/opt/homebrew/bin/stow {{ item }}"
  register: dotfiles_result
  changed_when: "'changed' in dotfiles_result.stdout"
  args:
    chdir: ~/dotfiles
  when: ansible_os_family == "Darwin"

# https://github.com/jorgebucaran/fisher
- name: Check if fisher install needed
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    fisher list
  args:
    executable: "{{ '/opt/homebrew/bin/fish' if ansible_os_family == 'Darwin' else '/usr/bin/fish' }}"
  register: fisher_status
  changed_when: false
  ignore_errors: true

- name: Download fisher
  become: true
  become_user: "{{ username }}"
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish
    dest: /tmp/fisher.sh
    mode: "0755"
  when: fisher_status is failed

- name: Install fisher
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: source /tmp/fisher.sh && fisher install jorgebucaran/fisher
  args:
    executable: "{{ '/opt/homebrew/bin/fish' if ansible_os_family == 'Darwin' else '/usr/bin/fish' }}"
  register: fisher_installed
  when: fisher_status is failed
  changed_when: "'changed ' in fisher_installed.stdout"

- name: Check if forgit is installed
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    fisher list | grep wfxr/forgit
  args:
    executable: "{{ '/opt/homebrew/bin/fish' if ansible_os_family == 'Darwin' else '/usr/bin/fish' }}"
  register: forgit_status
  changed_when: false
  ignore_errors: true

- name: Install forgit
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    fisher install wfxr/forgit
  args:
    executable: "{{ '/opt/homebrew/bin/fish' if ansible_os_family == 'Darwin' else '/usr/bin/fish' }}"
  when: forgit_status is failed
  register: forgit_install
  changed_when: "'changed' in forgit_install.stdout"

- name: Check if bobthefish is installed
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    fisher list | grep bobthefish
  args:
    executable: "{{ '/opt/homebrew/bin/fish' if ansible_os_family == 'Darwin' else '/usr/bin/fish' }}"
  register: bobthefish_status
  changed_when: false
  ignore_errors: true

- name: Install bobthefish
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    fisher install oh-my-fish/theme-bobthefish
  args:
    executable: "{{ '/opt/homebrew/bin/fish' if ansible_os_family == 'Darwin' else '/usr/bin/fish' }}"
  when: bobthefish_status is failed
  register: bobthefish_install
  changed_when: "'changed' in bobthefish_install.stdout"

---
# Clawdbot installation and configuration

# Install clawdbot globally via npm
- name: Install clawdbot via npm
  become: true
  become_user: "{{ clawdbot_user }}"
  ansible.builtin.shell: |
    export PATH="/home/{{ clawdbot_user }}/.local/share/fnm:$PATH"
    eval "$(fnm env)"
    npm install -g {{ clawdbot_npm_package }}
  register: npm_install
  changed_when: "'added' in npm_install.stdout or 'up to date' not in npm_install.stdout"
  when: clawdbot_install_method == "npm"
  tags:
    - clawdbot
    - install

# Verify clawdbot is installed
- name: Check clawdbot installation
  become: true
  become_user: "{{ clawdbot_user }}"
  ansible.builtin.shell: |
    export PATH="/home/{{ clawdbot_user }}/.local/share/fnm:$PATH"
    eval "$(fnm env)"
    clawdbot --version
  register: clawdbot_version
  changed_when: false
  tags:
    - clawdbot
    - install

# Clone workspace repository
- name: Clone workspace repository
  become: true
  become_user: "{{ clawdbot_user }}"
  ansible.builtin.git:
    repo: "{{ clawdbot_workspace_repo }}"
    dest: "{{ clawdbot_workspace_path }}"
    version: main
    accept_hostkey: true
  when: clawdbot_workspace_repo | length > 0
  tags:
    - clawdbot
    - workspace

# Create config directory
- name: Create clawdbot config directory
  become: true
  become_user: "{{ clawdbot_user }}"
  ansible.builtin.file:
    path: "{{ clawdbot_config_dir }}"
    state: directory
    mode: "0700"
  tags:
    - clawdbot
    - config

# Deploy config from template (placeholder - configure via wizard or migration)
- name: Deploy clawdbot config (placeholder)
  become: true
  become_user: "{{ clawdbot_user }}"
  ansible.builtin.template:
    src: clawdbot.json.j2
    dest: "{{ clawdbot_config_file }}"
    mode: "0600"
    force: false  # Don't overwrite if config already exists
  notify: Restart clawdbot
  tags:
    - clawdbot
    - config

# Create systemd service
- name: Deploy clawdbot systemd service
  become: true
  ansible.builtin.template:
    src: clawdbot.service.j2
    dest: /etc/systemd/system/clawdbot.service
    mode: "0644"
  notify:
    - Reload systemd
    - Restart clawdbot
  tags:
    - clawdbot
    - systemd

# Enable and start service
- name: Enable clawdbot service
  become: true
  ansible.builtin.systemd:
    name: clawdbot
    enabled: true
    state: started
    daemon_reload: true
  tags:
    - clawdbot
    - systemd
    - molecule-notest

# Configure Tailscale Serve for HTTPS + auth
- name: Configure Tailscale Serve
  become: true
  ansible.builtin.shell: |
    tailscale serve --bg --https=443 http://localhost:{{ clawdbot_port }}
  when: clawdbot_tailscale_serve
  changed_when: false
  tags:
    - clawdbot
    - tailscale
    - molecule-notest

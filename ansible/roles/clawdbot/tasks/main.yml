---
# Clawdbot installation and configuration

# Check current clawdbot version
- name: Check current clawdbot version
  become: true
  become_user: "{{ clawdbot_user }}"
  ansible.builtin.shell: |
    export PATH="/home/{{ clawdbot_user }}/.local/share/fnm:$PATH"
    eval "$(fnm env)"
    clawdbot --version 2>/dev/null || echo "not installed"
  register: clawdbot_current_version
  changed_when: false
  tags:
    - clawdbot
    - install

# Install clawdbot globally via npm
- name: Install clawdbot via npm
  become: true
  become_user: "{{ clawdbot_user }}"
  ansible.builtin.shell: |
    export PATH="/home/{{ clawdbot_user }}/.local/share/fnm:$PATH"
    eval "$(fnm env)"
    npm install -g {{ clawdbot_npm_package }}{% if clawdbot_version | length > 0 %}@{{ clawdbot_version }}{% endif %}

  register: npm_install
  changed_when: "'added' in npm_install.stdout or 'up to date' not in npm_install.stdout"
  tags:
    - clawdbot
    - install

# Clone workspace repository
- name: Clone workspace repository
  become: true
  become_user: "{{ clawdbot_user }}"
  ansible.builtin.git:
    repo: "{{ clawdbot_workspace_repo }}"
    dest: "{{ clawdbot_workspace_path }}"
    version: main
    accept_hostkey: true
  when: clawdbot_workspace_repo | length > 0
  tags:
    - clawdbot
    - workspace

# Create config directory
- name: Create clawdbot config directory
  become: true
  become_user: "{{ clawdbot_user }}"
  ansible.builtin.file:
    path: "{{ clawdbot_config_dir }}"
    state: directory
    mode: "0700"
  tags:
    - clawdbot
    - config

# Deploy config from template (placeholder - configure via wizard or migration)
- name: Deploy clawdbot config (placeholder)
  become: true
  become_user: "{{ clawdbot_user }}"
  ansible.builtin.template:
    src: clawdbot.json.j2
    dest: "{{ clawdbot_config_file }}"
    mode: "0600"
    force: false  # Don't overwrite if config already exists
  notify: Restart clawdbot
  tags:
    - clawdbot
    - config

# Create directory for environment file
- name: Create clawdbot etc directory
  become: true
  ansible.builtin.file:
    path: /etc/clawdbot
    state: directory
    owner: root
    group: root
    mode: "0700"
  tags:
    - clawdbot
    - config

# Deploy 1Password service account token (root-only for security)
- name: Deploy 1Password environment file
  become: true
  ansible.builtin.copy:
    content: |
      # 1Password service account token for Clawdbot
      # Managed by Ansible - do not edit
      OP_SERVICE_ACCOUNT_TOKEN={{ clawdbot_op_service_account_token }}
    dest: /etc/clawdbot/op.env
    owner: root
    group: root
    mode: "0600"
  when: clawdbot_op_service_account_token | length > 0
  notify: Restart clawdbot
  no_log: true  # Don't log the token
  tags:
    - clawdbot
    - config

# Create systemd service
- name: Deploy clawdbot systemd service
  become: true
  ansible.builtin.template:
    src: clawdbot.service.j2
    dest: /etc/systemd/system/clawdbot.service
    mode: "0644"
  notify:
    - Reload systemd
    - Restart clawdbot
  tags:
    - clawdbot
    - systemd

# Enable and start service
- name: Enable clawdbot service
  become: true
  ansible.builtin.systemd:
    name: clawdbot
    enabled: true
    state: started
    daemon_reload: true
  tags:
    - clawdbot
    - systemd
    - molecule-notest

# Configure Tailscale Serve for HTTPS + auth
- name: Configure Tailscale Serve
  become: true
  ansible.builtin.shell: |
    tailscale serve --bg --https=443 http://localhost:{{ clawdbot_port }}
  when: clawdbot_tailscale_serve
  changed_when: false
  tags:
    - clawdbot
    - tailscale
    - molecule-notest

---
- name: Install prereqs (Ubuntu/Debian)
  become: true
  tags: prereqs
  ansible.builtin.apt:
    update_cache: true
    pkg:
      - python3-debian
  when: ansible_os_family == "Debian"

- name: Install 1password
  ansible.builtin.include_role:
    name: compscidr.onepassword.onepassword
    apply:
      tags: 1password
      become: true
  tags: always

- name: Check if 1Password settings file exists (Ubuntu/Debian)
  tags: 1password
  become: true
  become_user: "{{ username }}"
  ansible.builtin.stat:
    path: "~/.config/1Password/settings/settings.json"
  register: onepassword_settings
  when: ansible_os_family == "Debian"

- name: Enable 1Password CLI integration (Ubuntu/Debian)
  tags: 1password
  become: true
  become_user: "{{ username }}"
  ansible.builtin.shell: |
    if jq -e '."developers.cliSharedLockState.enabled" == true' ~/.config/1Password/settings/settings.json > /dev/null 2>&1; then
      echo "1Password CLI integration already enabled"
    else
      jq '."developers.cliSharedLockState.enabled" = true' ~/.config/1Password/settings/settings.json > ~/.config/1Password/settings/settings.json.tmp && \
        mv ~/.config/1Password/settings/settings.json.tmp ~/.config/1Password/settings/settings.json
      echo "1Password CLI integration enabled"
    fi
  when:
    - ansible_os_family == "Debian"
    - onepassword_settings.stat.exists
  register: cli_integration_result
  changed_when: '"1Password CLI integration enabled" in cli_integration_result.stdout'

- name: Install discord apt repo (Ubuntu/Debian)
  tags: discord
  become: true
  ansible.builtin.deb822_repository:
    name: discord
    types: [deb]
    uris: https://palfrey.github.io/discord-apt/debian
    signed_by: https://palfrey.github.io/discord-apt/discord-apt.gpg.asc
    suites: ./
    state: present
    enabled: true
  when: ansible_os_family == "Debian"

- name: Install discord (Ubuntu/Debian)
  become: true
  tags: discord
  ansible.builtin.apt:
    update_cache: true
    pkg:
      - discord
  when: ansible_os_family == "Debian"

- name: Install discord (macOS)
  tags: discord
  community.general.homebrew_cask:
    name: discord
    state: present
  when: ansible_os_family == "Darwin"

- name: Install signal apt repo (Ubuntu/Debian)
  tags: signal
  become: true
  ansible.builtin.deb822_repository:
    name: signal
    types: [deb]
    uris: https://updates.signal.org/desktop/apt
    signed_by: https://updates.signal.org/desktop/apt/keys.asc
    suites: [xenial]
    components: [main]
    state: present
    enabled: true
  when: ansible_os_family == "Debian"

- name: Install signal (Ubuntu/Debian)
  become: true
  tags: signal
  ansible.builtin.apt:
    update_cache: true
    pkg:
      - signal-desktop
  when: ansible_os_family == "Debian"

- name: Install signal (macOS)
  tags: signal
  community.general.homebrew_cask:
    name: signal
    state: present
  when: ansible_os_family == "Darwin"

- name: Ensure template directory exists
  tags: UI
  become: true
  become_user: "{{ username }}"
  ansible.builtin.file:
    path: "~/Templates"
    mode: "0755"
    state: directory
  when: ansible_os_family == "Debian"

- name: Create new File context menu
  tags: UI
  become: true
  become_user: "{{ username }}"
  ansible.builtin.file:
    path: "~/Templates/Empty Document"
    state: touch
    mode: '0600'
    modification_time: preserve
    access_time: preserve
  when: ansible_os_family == "Debian"

# why you might want to swtich up terminal emulators:
# https://www.reddit.com/r/linuxquestions/comments/ri3yjg/comment/hout26s/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button
# (note this will change the ctrl-cmd-t to use this one). Change back with: sudo update-alternatives --config x-terminal-emulator
- name: Install terminal emulators (Ubuntu/Debian)
  tags: terminal-emulators
  become: true
  ansible.builtin.apt:
    pkg: "{{ common_gui_terminal_emulators_ubuntu }}"
  when: ansible_os_family == "Debian"

- name: Install terminal emulators (macOS)
  tags: terminal-emulators
  community.general.homebrew_cask:
    name: "{{ common_gui_terminal_emulators_macos }}"
    state: present
  when: ansible_os_family == "Darwin"

- name: Install spotify apt repo (Ubuntu/Debian)
  tags: always
  ansible.builtin.include_role:
    name: compscidr.spotify.spotify
    apply:
      become: true
      tags: spotify
  when: ansible_os_family == "Debian"
  register: spotify_role_result

- name: Cleanup spotify duplicate apt (Ubuntu/Debian)
  become: true
  tags: spotify
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/spotify.list
    state: absent
  when:
    - ansible_os_family == "Debian"
    - spotify_role_result is changed

- name: Install spotify (macOS)
  tags: spotify
  community.general.homebrew_cask:
    name: spotify
    state: present
  when: ansible_os_family == "Darwin"

- name: AppImage compatibility
  become: true
  tags: AppImage
  ansible.builtin.apt:
    update_cache: true
    pkg:
      - libfuse2
  when: ansible_os_family == "Debian"

- name: Install slack (Ubuntu/Debian)
  tags: slack
  become: true
  ansible.builtin.apt:
    deb: https://downloads.slack-edge.com/desktop-releases/linux/x64/4.43.51/slack-desktop-4.43.51-amd64.deb
  when: ansible_os_family == "Debian"

- name: Install slack (macOS)
  tags: slack
  community.general.homebrew_cask:
    name: slack
    state: present
  when: ansible_os_family == "Darwin"

- name: Check if keybase is already installed (Ubuntu/Debian)
  tags: always
  become: true
  ansible.builtin.stat:
    path: /usr/bin/keybase
  register: keybase_installed
  when: ansible_os_family == "Debian"

- name: Install keybase (Ubuntu/Debian)
  ansible.builtin.include_role:
    name: compscidr.keybase.keybase
    apply:
      tags: keybase
      become: true
  when:
    - ansible_os_family == "Debian"
    - not keybase_installed.stat.exists
  tags: always

- name: Install keybase (macOS)
  tags: keybase
  community.general.homebrew_cask:
    name: keybase
    state: present
  when: ansible_os_family == "Darwin"

- name: Download and install telegram (Ubuntu/Debian)
  tags: telegram
  become: true
  ansible.builtin.unarchive:
    src: https://updates.tdesktop.com/tlinux/tsetup.6.2.3.tar.xz
    dest: /opt/
    remote_src: true
  when: ansible_os_family == "Debian"

- name: Install telegram (macOS)
  tags: telegram
  community.general.homebrew_cask:
    name: telegram
    state: present
  when: ansible_os_family == "Darwin"

- name: Install Gimp (Ubuntu/Debian)
  tags: gimp
  become: true
  ansible.builtin.apt:
    name: gimp
    state: present
  when: ansible_os_family == "Debian"

- name: Install Gimp (macOS)
  tags: gimp
  community.general.homebrew_cask:
    name: gimp
    state: present
  when: ansible_os_family == "Darwin"

- name: Install zoom (Ubuntu/Debian)
  tags: zoom
  become: true
  ansible.builtin.apt:
    deb: https://zoom.us/client/latest/zoom_amd64.deb
  when: ansible_os_family == "Debian"

- name: Check if Zoom is already installed (macOS)
  tags: zoom
  ansible.builtin.stat:
    path: /Applications/zoom.us.app
  register: zoom_check
  when: ansible_os_family == "Darwin"

- name: Download Zoom installer (macOS)
  tags: zoom
  ansible.builtin.get_url:
    url: https://zoom.us/client/latest/Zoom.pkg
    dest: /tmp/Zoom.pkg
    mode: '0644'
  when:
    - ansible_os_family == "Darwin"
    - not zoom_check.stat.exists

- name: Install Zoom from package (macOS)
  tags: zoom
  become: true
  ansible.builtin.command: installer -pkg /tmp/Zoom.pkg -target /
  when:
    - ansible_os_family == "Darwin"
    - not zoom_check.stat.exists

- name: Clean up Zoom installer (macOS)
  tags: zoom
  ansible.builtin.file:
    path: /tmp/Zoom.pkg
    state: absent
  when: ansible_os_family == "Darwin"

- name: Install variety
  tags: UI
  become: true
  ansible.builtin.apt:
    pkg:
      - variety
  when: ansible_os_family == "Debian"

- name: Install chrome browser (Ubuntu/Debian)
  tags: chrome
  become: true
  ansible.builtin.apt:
    deb: https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  when: ansible_os_family == "Debian"

- name: Install chrome browser (macOS)
  tags: chrome
  community.general.homebrew_cask:
    name: google-chrome
    state: present
  when: ansible_os_family == "Darwin"

- name: Set dock icons
  tags: dock
  become: true
  become_user: "{{ username }}" # really important to have the username here, or it will seem like it isn't taking effect
  community.general.dconf:
    key: "/org/gnome/shell/favorite-apps"
    value: "['org.gnome.Terminal.desktop', 'google-chrome.desktop', 'firefox_firefox.desktop',
      'org.gnome.Nautilus.desktop', 'code.desktop', 'snap-store_snap-store.desktop']"
    state: present
  when: ansible_os_family == "Debian"

- name: Install Gnome Browser Connector for Extensions
  tags: gui
  become: true
  ansible.builtin.apt:
    pkg:
      - gnome-browser-connector
      - gnome-shell-extension-manager
  when: ansible_os_family == "Debian"

- name: Install Gnome Extensions
  tags:
    - gui
    - molecule-notest
  become: true
  ansible.builtin.import_role:
    name: luizgavalda.gnome_extensions
  vars:
    gnome_extension_ids:
      - 6580 # https://extensions.gnome.org/extension/6580/open-bar/
  when: ansible_os_family == "Debian"

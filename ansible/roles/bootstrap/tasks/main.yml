---
# Bootstrap role - minimal server provisioning
# Creates user and installs Docker
# Run after Tailscale is already installed (via cloud-init for servers)

- name: Create docker group
  become: true
  tags: [bootstrap, docker]
  ansible.builtin.group:
    name: docker
    state: present
  when: bootstrap_docker_enabled

- name: Create user (without password - servers)
  become: true
  tags: [bootstrap, user]
  ansible.builtin.user:
    name: "{{ bootstrap_username }}"
    shell: "{{ bootstrap_user_shell }}"
    groups: "{{ bootstrap_user_groups | join(',') }}"
    append: true
    create_home: true
  when: bootstrap_user_password | length == 0

- name: Create user (with password - workstations)
  become: true
  tags: [bootstrap, user]
  ansible.builtin.user:
    name: "{{ bootstrap_username }}"
    password: "{{ bootstrap_user_password | password_hash('sha512') }}"
    shell: "{{ bootstrap_user_shell }}"
    groups: "{{ bootstrap_user_groups | join(',') }}"
    append: true
    create_home: true
    update_password: on_create
  when: bootstrap_user_password | length > 0

- name: Allow passwordless sudo (servers - no password set)
  become: true
  tags: [bootstrap, user]
  ansible.builtin.copy:
    content: "{{ bootstrap_username }} ALL=(ALL) NOPASSWD:ALL\n"
    dest: "/etc/sudoers.d/{{ bootstrap_username }}"
    mode: "0440"
    validate: "visudo -cf %s"
  when: bootstrap_user_password | length == 0

- name: Allow sudo with password (workstations - password set)
  become: true
  tags: [bootstrap, user]
  ansible.builtin.file:
    path: "/etc/sudoers.d/{{ bootstrap_username }}"
    state: absent
  when: bootstrap_user_password | length > 0

- name: Install Docker (Ubuntu/Debian)
  become: true
  tags: [bootstrap, docker]
  ansible.builtin.apt:
    name:
      - docker.io
      - docker-compose-v2
    state: present
    update_cache: true
  when:
    - bootstrap_docker_enabled
    - ansible_os_family == "Debian"

- name: Ensure Docker service is running
  become: true
  tags: [bootstrap, docker]
  ansible.builtin.systemd:
    name: docker
    enabled: true
    state: started
  when:
    - bootstrap_docker_enabled
    - ansible_os_family == "Debian"
